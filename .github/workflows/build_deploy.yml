name: NixOS build and deploy config

on:
  workflow_dispatch:
  # We cannot include the paths-ignore part here because this check is set as
  # required for PRs. Otherwise the PR cannot be merged when this workflow does
  # not run.
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
    paths-ignore:
      - 'install.sh'
      - 'README.md'
      - '.gitignore'

jobs:

  shared:
    uses: 'msf-ocb/nixos/.github/workflows/reusable_build_deploy.yml@01d2d2b921f9d59733117e6f21a6c939af0f7af9'
    with:
      push_secrets:    false
      push_robot_keys: false
    secrets:
      NIXOS_OCB_CONFIG_DEPLOY_KEY: ${{ secrets.NIXOS_OCB_CONFIG_DEPLOY_KEY }}
      NIXOS_OCB_KEY_MGMT_API_TOKEN: ${{ secrets.NIXOS_OCB_KEY_MGMT_API_TOKEN }}
      NIXOS_ROBOT_KEY: ${{ secrets.NIXOS_ROBOT_KEY }}
      NIXOS_SECRET_MANAGEMENT_VAULT_KEY: ${{ secrets.NIXOS_SECRET_MANAGEMENT_VAULT_KEY }}

